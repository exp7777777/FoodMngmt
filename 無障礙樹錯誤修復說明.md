# 無障礙樹（AXTree）錯誤修復說明

## 問題描述

錯誤訊息：
```
[ERROR:flutter/shell/platform/common/accessibility_bridge.cc(65)] 
Failed to update ui::AXTree, error: 4 will not be in the tree and is not the new root
```

## 問題原因

Flutter 的無障礙樹（Accessibility Tree）在快速的 UI 變化時無法及時同步，導致以下場景出現錯誤：

### 出問題的場景

1. **主頁影像辨識流程**
   ```
   選擇圖片 → 顯示 loading 對話框 → 辨識完成 → 立即關閉對話框 → 立即導航 ❌
   ```
   
2. **表單影像辨識流程**
   ```
   選擇圖片 → 設置 loading 狀態 → 辨識完成 → 立即關閉 loading → 立即顯示對話框 ❌
   ```

### 為什麼會出錯？

無障礙樹需要時間來：
- 從對話框的狀態更新
- 到新頁面的狀態
- 或從 loading 狀態到正常狀態

當這些變化太快時（毫秒級），無障礙樹來不及同步。

## 修復方案

### 方案核心

1. **添加延遲** - 在狀態變化之間添加 100ms 延遲
2. **使用 addPostFrameCallback** - 確保在下一幀再執行導航

### 修復 1：root_scaffold.dart（主頁影像辨識）

#### 正常流程修復

```dart
// 關閉 loading
if (rc.mounted) {
  try {
    Navigator.of(rc).pop();
    // ✅ 添加延遲，讓無障礙樹有時間更新
    await Future.delayed(const Duration(milliseconds: 100));
  } catch (_) {
    // loading 對話框可能已被關閉
  }
}

// ✅ 使用 addPostFrameCallback 確保在正確的時機導航
if (rc.mounted) {
  WidgetsBinding.instance.addPostFrameCallback((_) {
    if (rc.mounted) {
      Navigator.push(
        rc,
        MaterialPageRoute(
          builder: (_) => FoodFormPage(initial: recognizedFood),
        ),
      );
    }
  });
}
```

**改進點：**
- ✅ 關閉對話框後等待 100ms
- ✅ 使用 `addPostFrameCallback` 在下一幀導航
- ✅ 雙重 mounted 檢查

#### 錯誤處理流程修復

```dart
// 關閉 loading
if (rc.mounted) {
  try {
    Navigator.of(rc).pop();
    // ✅ 添加延遲，避免 AXTree 錯誤
    await Future.delayed(const Duration(milliseconds: 100));
  } catch (_) {
    // 如果 dialog 不存在則忽略
  }
}

// 顯示錯誤提示
if (rc.mounted) {
  ScaffoldMessenger.of(rc).showSnackBar(...);

  // ✅ 使用 addPostFrameCallback 導航
  WidgetsBinding.instance.addPostFrameCallback((_) {
    if (rc.mounted) {
      Navigator.push(...);
    }
  });
}
```

### 修復 2：pages_food_form.dart（表單影像辨識）

```dart
// 辨識完成
setState(() => _isRecognizing = false);

// ✅ 添加小延遲，讓無障礙樹有時間更新
await Future.delayed(const Duration(milliseconds: 100));

// 然後才處理結果或顯示對話框
if (mounted && identifiedFoods != null) {
  if (identifiedFoods.length == 1) {
    _applyRecognitionResult(identifiedFoods.first);
  } else {
    final selectedFood = await ImageRecognitionHelper
        .showFoodSelectionDialogForForm(...);
    
    if (selectedFood != null && mounted) {
      _applyRecognitionResult(selectedFood);
    }
  }
}
```

**改進點：**
- ✅ 關閉 loading 狀態後等待 100ms
- ✅ 確保 UI 有時間更新再顯示對話框

## 修復效果

### 修復前的時間線
```
0ms:   關閉對話框
0ms:   嘗試導航 ← 無障礙樹還沒更新 ❌
錯誤: Failed to update ui::AXTree
```

### 修復後的時間線
```
0ms:   關閉對話框
100ms: 等待延遲
100ms: 無障礙樹已更新 ✅
116ms: addPostFrameCallback 觸發
116ms: 導航成功 ✅
```

## 技術說明

### Future.delayed()
```dart
await Future.delayed(const Duration(milliseconds: 100));
```
**作用：** 暫停執行 100 毫秒，讓 Flutter 有時間完成狀態同步。

### WidgetsBinding.instance.addPostFrameCallback()
```dart
WidgetsBinding.instance.addPostFrameCallback((_) {
  // 在下一幀執行
});
```
**作用：** 確保在當前幀渲染完成後，在下一幀才執行操作。

### 為什麼是 100ms？

- **太短（< 50ms）** - 可能還是來不及同步
- **太長（> 200ms）** - 使用者會感覺到延遲
- **100ms** - 平衡點，既能確保同步，又不會被察覺

## 測試建議

### 測試 1：主頁影像辨識
1. 點擊底部浮動按鈕
2. 選擇圖片
3. 觀察 console
4. ✅ 不應該出現 AXTree 錯誤

### 測試 2：主頁影像辨識（多個結果）
1. 點擊底部浮動按鈕
2. 選擇包含多個食物的圖片
3. 選擇其中一個
4. 觀察 console
5. ✅ 不應該出現 AXTree 錯誤

### 測試 3：表單影像辨識
1. 進入新增食材頁面
2. 點擊選擇圖片
3. 選擇圖片
4. 觀察 console
5. ✅ 不應該出現 AXTree 錯誤

### 測試 4：快速操作
1. 連續快速點擊影像辨識
2. 快速選擇圖片並選擇結果
3. 觀察 console
4. ✅ 不應該出現 AXTree 錯誤

## 副作用評估

### ✅ 優點
1. **消除錯誤** - 解決無障礙樹錯誤
2. **更穩定** - UI 狀態變化更可控
3. **更安全** - 雙重 mounted 檢查

### ⚠️ 注意事項
1. **輕微延遲** - 100ms 的延遲（幾乎察覺不到）
2. **記憶體** - 使用 callback 需要注意清理（已處理）

### 實際影響
- **使用者體驗** - 幾乎無影響（100ms 很難察覺）
- **效能** - 無明顯影響
- **穩定性** - 大幅提升

## 相關資源

### Flutter 官方文檔
- [WidgetsBinding](https://api.flutter.dev/flutter/scheduler/WidgetsBinding-class.html)
- [addPostFrameCallback](https://api.flutter.dev/flutter/scheduler/SchedulerBinding/addPostFrameCallback.html)

### 相關問題
- [Flutter Issue #12689](https://github.com/flutter/flutter/issues/12689)
- [Flutter Issue #45735](https://github.com/flutter/flutter/issues/45735)

## 最佳實踐

### 對話框 + 導航
```dart
// ✅ 推薦做法
Navigator.pop(context);
await Future.delayed(const Duration(milliseconds: 100));
WidgetsBinding.instance.addPostFrameCallback((_) {
  if (mounted) Navigator.push(...);
});

// ❌ 不推薦
Navigator.pop(context);
Navigator.push(...); // 太快，可能出錯
```

### setState + 對話框
```dart
// ✅ 推薦做法
setState(() => loading = false);
await Future.delayed(const Duration(milliseconds: 100));
showDialog(...);

// ❌ 不推薦
setState(() => loading = false);
showDialog(...); // 太快，可能出錯
```

## 修改的檔案

1. ✅ **lib/root_scaffold.dart**
   - 第 197 行：添加延遲
   - 第 204-215 行：使用 addPostFrameCallback
   - 第 225 行：錯誤處理添加延遲
   - 第 241-249 行：錯誤處理使用 addPostFrameCallback

2. ✅ **lib/pages_food_form.dart**
   - 第 311 行：添加延遲

## 更新日期
2025-10-27

## 相關文件
- [影像辨識代碼整合](./影像辨識代碼整合說明.md)
- [影像辨識穩定性改進](./影像辨識改進說明.md)

